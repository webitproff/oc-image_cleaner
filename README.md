# Image Cleaner Utility для ocStore / OpenCart

[![Лицензия](https://img.shields.io/badge/лицензия-BSD-blue.svg)](https://github.com/webitproff/oc-image_cleaner/blob/main/LICENSE)
[![Версия](https://img.shields.io/badge/версия-2.0.1-green.svg)](https://github.com/webitproff/oc-image_cleaner/releases)
[![Совместимость с ocStore](https://img.shields.io/badge/ocStore-3.0.3.7-orange.svg)](https://ocstore.com/)
[![PHP](https://img.shields.io/badge/PHP-7.3-blueviolet.svg)](https://www.php.net/releases/7_3_0.php)

## Общая информация

**Image Cleaner** — это модуль для ocStore/OpenCart, предназначенный для поиска и удаления неиспользуемых изображений из папки `/image/catalog/`. Этот модуль помогает поддерживать ваш сайт оптимизированным, освобождая дисковое пространство, удаляя изображения, которые не используются на сайте, например, не привязанные к товарам, категориям, баннерам, производителям, информационным страницам или блогам.

Модуль интегрируется в административную панель и добавляет пункт меню «Уборка в картинках», через который можно запускать проверку и удаление неиспользуемых изображений.

## Введение для новичков

**Image Cleaner Utility** — это простой модуль для интернет-магазина на ocStore (или OpenCart), который помогает найти и удалить ненужные картинки из папки `/image/catalog/`. 
	Если вы не знаете, что такое PHP, база данных, FTP или OCMOD — этот документ должен помочь. Всегда можно задать вопрос или обратиться к любому специалисту-кодеру.

**Зачем это нужно?** Когда вы добавляете товары, категории или баннеры в магазин, изображения сохраняются в папке `/image/catalog/`. Если вы удаляете товар, его картинки могут остаться — это "мусор", который занимает место на сервере. Image Cleaner находит такие файлы и позволяет их удалить через админ-панель, не копаясь в коде.

**Важно для новичков**: **Сделайте резервную копию сайта** (все файлы + база данных) перед использованием! Используйте FileZilla для файлов и phpMyAdmin для базы данных. Это спасёт, если что-то пойдёт не так.


### Почему это важно

При работе с интернет-магазином со временем накапливаются изображения, которые больше нигде не используются. Они занимают место на сервере и могут замедлять или делать невозможным резервное копирование сайта. Image Cleaner позволяет безопасно удалить такие файлы.

## Основные возможности

* Сканирование папки `/image/catalog/` на наличие неиспользуемых изображений.
* Удаление найденных файлов с подтверждением действия.
* Белый список критически важных файлов, которые нельзя удалять (`placeholder.png`, `no_image.png`, логотип магазина).
* Проверка HTML-описаний товаров, страниц и блогов для поиска используемых изображений.
* Отображение результатов проверки и удаления прямо в админ-панели.
* Защита с помощью CSRF-токена (`user_token`).
* Проверка прав на файлы перед удалением.
* Многоязычная поддержка. Добавляет в админ-панель пункт меню с названием:
  - "Уборка в картинках" (русский).
  - "Image Cleanup" (английский).
  - "Очищення зображень" (украинский).
* **OCMOD**: На данный момент модуль **не использует OCMOD** (систему модификаторов ocStore/OpenCart).
	Установка требует ручного копирования файлов и простейшей правки кода в одном файле (см. раздел "Подробная инструкция по установке").
	В будущем, для **Image Cleaner Utility** поддержка OCMOD также не планируется, достаточно, если вы хоть не много можете читать код, а если нет - то стоит обратиться к такому человеку.


## Структура файлов модуля

```
admin/
├── controller/
│   └── tool/
│       └── image_cleaner.php   # Логика модуля
├── language/
│   ├── en-gb/tool/image_cleaner.php // английская локализация модуля
│   ├── ru-ru/tool/image_cleaner.php // русская локализация модуля
│   └── uk-ua/tool/image_cleaner.php // украинская локализация модуля
└── view/
    └── template/
        └── tool/
            └── image_cleaner.twig  # Шаблон отображения интерфейса управления утилитой
```


## Требования (проверьте перед установкой)

Чтобы модуль работал, ваш магазин должен соответствовать этим требованиям:
- **ocStore/OpenCart**: Версия 3.0.3.7. Если у вас другая версия (например, OpenCart 3.x), протестируйте на копии сайта.
- **PHP**: Версия 7.3. Проверьте в админке: "Система" → "Информация о сервере" → найдите "PHP Version".
- **Доступ к файлам**: Нужен FTP (через FileZilla) или доступ через панель хостинга (cPanel, DirectAdmin и т.д.).
- **Права на файлы**: Папка `/image/catalog/` должна быть доступна для чтения и записи (права 755 для папок, 644 для файлов, иногда 777).
- **База данных**: MySQL или MariaDB, доступ через phpMyAdmin.
- **Модуль блога (опционально)**: Если используете OCTemplates блог (таблицы `oct_blogarticle_***`), модуль проверит и его изображения.

**Как узнать версию PHP?**
1. Зайдите в админку.
2. Перейдите: "Система" → "Информация о сервере".
3. Найдите строку "PHP Version". Если не 7.3, попросите хостинг обновить.

   
## Подробная инструкция по установке

Ниже описаны шаги для абсолютного новичка, чтобы модуль заработал корректно.

### 1. Скачивание модуля

* Перейдите на страницу проекта на GitHub: [https://github.com/webitproff/oc-image_cleaner](https://github.com/webitproff/oc-image_cleaner)
* Нажмите кнопку "Code" → "Download ZIP".
* Распакуйте архив на вашем компьютере.
* Либо для продвинутых можно использовать Git: `git clone https://github.com/webitproff/oc-image_cleaner.git`

### 2. Копирование файлов

* Скопируйте содержимое папки `upload/` из архива в корневую директорию вашего сайта, где установлен ocStore/OpenCart. Просто тупо папку `admin` копируем в папку сайта.
* **При копировании, текущие файлы движка не перезаписываются!**


### 3. Добавление пункта меню в админку

* Откройте файл `admin/controller/common/column_left.php`.
* Найдите строку:

```php
$this->load->language('common/column_left');
```

* После неё добавьте следующий код:
```php
$this->load->language('tool/image_cleaner'); // строка загрузки языковой локализации image_cleaner (Загружает переводы для модуля) 
```
* Найдите массив $data['menus'][] (это список пунктов меню админки). После первого пункта (обычно Dashboard, Панель стану, Панель состояния)::

```php
// Menu
$data['menus'][] = array(
	'id'       => 'menu-dashboard',
	'icon'	   => 'fa-dashboard',
	'name'	   => $this->language->get('text_dashboard'),
	'href'     => $this->url->link('common/dashboard', 'user_token=' . $this->session->data['user_token'], true),
	'children' => array()
);
```

* После неё добавьте следующий код:
```php

// start пункт меню утилиты image_cleaner
$data['menus'][] = array(
	'id'       => 'menu-tool-image-cleaner',
	'icon'     => 'fa fa-trash-o',
	'name'	   => $this->language->get('image_cleaner_title'),
	'href'     => $this->url->link('tool/image_cleaner', 'user_token=' . $this->session->data['user_token'], true),
	'children' => array()
);
// end пункт меню утилиты image_cleaner
```

* Это добавит пункт меню "Уборка в картинках" с иконкой корзины в левую колонку админки.

### 4. Проверка прав доступа к модулю

Чтобы модуль был виден и функционален, нужно выдать права пользователям:

1. В админ-панели перейдите в **Система → Пользователи → Группы пользователей**.
2. Найдите группу, которой нужно дать доступ (обычно `Администратор`), и нажмите **Изменить**.
3. Вкладки:

   * **Доступ к модулям (Access Permission)**
   * **Права на изменение (Modify Permission)**
4. В обоих списках поставьте галочку напротив:

```
tool/image_cleaner
```

5. Нажмите **Сохранить**. После этого пользователи группы смогут видеть модуль в меню и использовать его функционал.

### 5. Проверка прав на папку с изображениями

* Убедитесь, что папка `/image/catalog/` имеет права на чтение и запись.
* Обычно достаточно прав `755`. Если модуль не видит файлы или не может их удалить, можно временно выставить `777`.

### 6. Очистка кэша

* В админ-панели ocStore перейдите в **Система → Инструменты → Очистка кэша**.
* Нажмите кнопки очистки кэша системы и кэша шаблонов.

## Использование модуля

### 1. Открытие модуля

* В админ-панели найдите пункт меню «Уборка в картинках».
* Кликните по нему, откроется интерфейс модуля.

### 2. Сканирование изображений

* Нажмите кнопку «Проверить».
* Модуль просканирует папку `/image/catalog/` и проанализирует базу данных, чтобы определить, какие изображения не используются.
* После завершения сканирования появится список неиспользуемых изображений.

### 3. Удаление изображений

* Если вы уверены, что хотите удалить неиспользуемые изображения, нажмите кнопку «Удалить».
* Появится предупреждение, так как удаление необратимо.
* После подтверждения удалятся файлы, которые не используются, кроме тех, что находятся в белом списке.
* Результаты удаления отобразятся на экране: файлы, удаленные успешно, и файлы, которые не удалось удалить.

### 4. Резервное копирование

* Перед удалением обязательно сделайте резервную копию папки `/image/catalog/`.
* Это позволит восстановить файлы, если случайно будут удалены нужные изображения.

## Принцип работы модуля

* Модуль проверяет наличие таблиц базы данных: `product`, `product_image`, `category`, `banner_image`, `manufacturer`, `information_description`, `product_description`, `oct_blogarticle`, `oct_blogarticle_description`.
* Извлекает все пути изображений из полей `image`.
* Анализирует HTML-описания товаров, страниц и блогов для поиска всех `<img src>` и `<a href>` с `/catalog/`.
* Создает список всех используемых изображений и удаляет дубликаты.
* Сравнивает файлы в папке `/image/catalog/` с этим списком.
* Файлы, отсутствующие в базе и не входящие в белый список, считаются неиспользуемыми.
* При подтверждении удаления файлы удаляются, если есть права на запись.

## Белый список

Файлы, которые никогда не удаляются:

* `catalog/placeholder.png`
* `catalog/no_image.png`
* Логотип магазина (`config_logo`)

## Технические детали

* Версия: 2.0.1
* Совместимость: ocStore 3.0.3.7, OpenCart 3.x
* PHP: 7.3
* Использует CSRF-токен (`user_token`) для защиты от атак
* Проверяет права на файлы перед удалением
* Проверяет наличие таблиц перед выполнением SQL-запросов

## Ограничения

* Удаление необратимо — обязательно создавайте резервную копию
* Кастомные модули с изображениями могут не учитываться
* Поддержка OCT Blog только при наличии таблиц `oct_blogarticle` и `oct_blogarticle_description`

Структура кода (что делает каждый файл)
Для новичков: код — это инструкции для вашего сайта. Вот что делает каждый файл модуля:
1. Контроллер: admin/controller/tool/image_cleaner.php

Это "мозг" модуля, написан на PHP.
Два главных метода:

index():

Загружает переводы ($this->load->language('tool/image_cleaner')).
Устанавливает заголовок страницы (Очистка неиспользуемых изображений).
Создаёт ссылки для кнопок "Проверить" (action=scan) и "Удалить" (action=delete).
Загружает шаблон страницы (image_cleaner.twig).


scanUnusedImages($delete):

Собирает все используемые изображения из базы данных:

Таблицы: product, product_image, category, banner_image, manufacturer, oct_blogarticle, oct_blogarticle_image.
Поля: image (например, catalog/product.jpg).
Описания: information_description, product_description, oct_blogarticle_description (ищет <img src="catalog/...").


Сравнивает с файлами в /image/catalog/.
Если $delete = true, удаляет ненужные файлы.
Возвращает список результатов (пути файлов или сообщения).




Как работает?

Проверяет таблицы базы данных (например, SELECT image FROM oc_product).
Парсит HTML-описания с помощью регулярных выражений (preg_match_all) для поиска путей (src, href).
Нормализует пути: убирает image/, заменяет \ на /.
Обходит папку /image/catalog/ с помощью RecursiveIteratorIterator.
Игнорирует файлы из белого списка (placeholder.png, no_image.png, логотип).



2. Языковые файлы

Расположение: admin/language/*/tool/image_cleaner.php (ru-ru, en-gb, uk-ua).
Содержат переводы всех текстов. Пример (русский):
php$_['image_cleaner_title'] = 'Уборка в картинках'; // Название в меню
$_['heading_title'] = 'Очистка неиспользуемых изображений'; // Заголовок
$_['text_check'] = 'Проверить'; // Кнопка
$_['text_delete'] = 'Удалить'; // Кнопка
$_['text_warning'] = 'Удалить все неиспользуемые изображения? Это действие необратимо!';

Аналогично для английского и украинского. Если добавить новый язык, создайте файл в admin/language/код_языка/tool/.

3. Шаблон: admin/view/template/tool/image_cleaner.twig

Это HTML-страница в формате Twig (стандарт ocStore для интерфейса).
Содержит:

Заголовок ({{ heading_title }}).
Кнопки: "Проверить" ({{ scan_url }}) и "Удалить" ({{ delete_url }} с подтверждением).
Область результатов: <pre> с прокруткой для списка файлов.
Предупреждение о бэкапе ({{ text_backup }}).
Ссылку на GitHub ({{ image_cleaner_github }}).



4. Интеграция в меню: admin/controller/common/column_left.php

Добавляет пункт меню в админку.
Код (см. шаг 4 установки) загружает переводы и создаёт ссылку с иконкой корзины (fa-trash-o).
OCMOD: Поскольку модуль не использует OCMOD, этот файл редактируется вручную. OCMOD позволил бы автоматизировать этот шаг.

Технические детали (как работает под капотом)
Для новичков: не пугайтесь технических терминов, это просто объяснение, как модуль делает свою работу.

Сканирование:

Проверяет таблицы базы данных:

product, product_image, category, banner_image, manufacturer — стандартные таблицы ocStore.
oct_blogarticle, oct_blogarticle_image — для блога OCTemplates.


Извлекает пути изображений (например, catalog/product.jpg) из полей image.
Парсит HTML в описаниях в таблицах information_description, product_description, oct_blogarticle_description:

Ищет <img src="catalog/..." или href="catalog/..." с помощью preg_match_all.
Также ищет пути вида image/catalog/....


Убирает дубликаты и нормализует пути:
php$p = str_replace('\\', '/', $p); // Заменяет \ на /
$p = ltrim($p, '/'); // Убирает ведущий /
if (strpos($p, 'image/') === 0) {
    $p = substr($p, strlen('image/')); // Убирает image/
}

Сравнивает с файлами в /image/catalog/ с помощью RecursiveIteratorIterator.


Белый список:

Список файлов, которые нельзя удалять: catalog/placeholder.png, catalog/no_image.png.
Проверяет логотип магазина:
php$query_logo = $this->db->query("SELECT value FROM oc_setting WHERE key = 'config_logo' AND store_id = 0 LIMIT 1");
Если логотип есть, добавляет его в белый список.


Удаление:

Проверяет права файла (is_writable).
Удаляет с помощью unlink.
Если успех — добавляет ✅, если ошибка — ❌.


Безопасность:

Использует user_token для защиты от CSRF (чтобы никто не запустил удаление без входа в админку).
Проверяет существование таблиц перед запросами:
php$check = $this->db->query("SHOW TABLES LIKE '" . DB_PREFIX . "table'");

Игнорирует пустые описания и несуществующие папки.

## Требования

* ocStore/OpenCart 3.0.3.7
* PHP 7.3 или выше
* Папка `/image/catalog/` с правами на чтение и запись
* Необходимые таблицы в базе данных

## Команды

* Сканирование: `tool/image_cleaner?action=scan&user_token=...`
* Удаление: `tool/image_cleaner?action=delete&user_token=...`

## Автор

* webitproff — [GitHub](https://github.com/webitproff)
* Дата: 12 октября 2025
* Проект: [oc-image_cleaner](https://github.com/webitproff/oc-image_cleaner)

## Лицензия

BSD License

## Поддержка и вклад

* Создавайте issue: [GitHub Issues](https://github.com/webitproff/oc-image_cleaner/issues)
* Pull request приветствуются
